#!../build/LuaJIT-2.0.0/src/luajit
local results = {}
local failed,passed = 0,0
for line in io.popen("find . -name '*.t'"):lines() do
    local file = string.sub(line,3)
    local e = { k = file }
    table.insert(results,e)
    print(e.k..":")
    --things in the fail directory should cause terra compiler errors
    --we dont check for the particular error
    --but we do check to see that the "Errors reported.." message prints
    --which suggests that the error was reported gracefully
    --(if the compiler bites it before it finishes typechecking then it will not print this)
    if string.sub(file,1,5) == "fails" then
        if os.execute("../terra "..file.." | grep 'Errors reported during compilation'") ~= 0 then
            e.v = "FAIL"
            failed = failed + 1
        else
            e.v = "pass"
            passed = passed + 1
        end
    elseif string.sub(file,1,4) ~= "lib/" then
        if os.execute("../terra "..file) ~= 0 then
            e.v = "FAIL"
            failed = failed + 1
        else
            e.v = "pass"
            passed = passed + 1
        end
    end
end

for i,e in ipairs(results) do
    if e.v then
        print(i,e.v,e.k)
    end
end
print()
print(tostring(passed).." tests passed. "..tostring(failed).." tests failed.")